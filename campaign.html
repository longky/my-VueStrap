<!DOCTYPE html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>总部市场活动例子清单</title>
    <link rel="shortcut icon" href="https://static.thelittlegym.com.cn/assert/img/logo.ico"> 
    <link rel="stylesheet" href="https://static.thelittlegym.com.cn/assert/ui/semantic/semantic.min.css">
    <link rel="stylesheet" href="https://static.thelittlegym.com.cn/assert/ui/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="https://bbk.800app.com/uploadfile/staticresource/238592/279833/tlgc.css">
    <script src="https://bbk.800app.com/uploadfile/staticresource/238592/279833/gym.js"></script>
    <script src="https://bbk.800app.com/uploadfile/staticresource/238592/279833/jquery-1.11.3.min.js"></script>
    <link rel="stylesheet" href="https://static.thelittlegym.com.cn/assert/ui/iview/styles/iview.css">
    <link href="https://bbk.800app.com/uploadfile/staticresource/238592/279833/jQuery.toolTip.css" rel="stylesheet">
	<script src="https://bbk.800app.com/uploadfile/staticresource/238592/279833/jQuery.toolTip.js"></script>

    <!--[if lt IE 9]>
      <link rel="stylesheet" href="incompatible.css">
    <![endif]-->
    <script>
        var url_signlist="https://camp.thelittlegym.com.cn/api/crm/get/signlist";
		var url_coupon="https://camp.thelittlegym.com.cn/tlg/coupon/show/list";
        var url_jsonp = "https://bbk.800app.com/uploadfile/staticresource/238592/279833/dataInterface_jsonp_uni.aspx";
        var url_local = "https://bbk.800app.com//uploadfile/staticresource/238592/279833/api_auto_json.aspx";
        //var sql_campaign="select distinct crmzdy_82053258 name from crm_zdytable_238592_27045_238592_view camp  where crmzdy_82053258<>'' order by create_time desc"
        var sql_campaign="select crmzdy_82053258 name from crm_zdytable_238592_27045_238592_view camp  where crmzdy_82053258<>'' group by crmzdy_82053258 order by min(create_time) desc";
        var sql_getGym = "select crm_name name,gym.crmzdy_80620116 id,gym.crmzdy_82037329 status from crm_zdytable_238592_23594_238592_view gym join (select top 1 crm_jiandang,crm_qm,crmzdy_81611236 gymlist from crm_yh_238592_view where id=279833)yh on gym.crmzdy_80620116 >'500004' /*and gym.crmzdy_82037329=1 status*/ and (yh.crm_qm in ('月球运营总监开发','测试员工') or yh.crm_jiandang in ('@consultant','@administrator','市场顾问','市场专员') or (yh.crm_jiandang in ('中心运营总监','中心运营总监(练习)','中心员工','课程主管','销售主管','中心员工(练习)') and charindex(gym.crm_name,yh.gymlist)>0)) order by name";
        var sql_quanxian ="select crmzdy_81611236add;crm_jiandangadd;crm_qm acl fromnbsp;crm_yh_238592_viewnbsp;wherenbsp;id=279833";
        var sql_preEnrol = "select/*main*/ isnull(crmzdy_87686127,'') member_status,isnull(cast(crmzdy_87687498 as varchar),'0')deposit,isnull(crmzdy_87687305,'') tys,crmzdy_87685999 dtClass,isnull(crmzdy_87677030,'') membername,crmzdy_87677024 level,isnull(crmzdy_87677136,'') amt,isnull(crmzdy_87677139,'') dtsign,crmzdy_87677027 dtlevelexpire,crmzdy_87673584 juli,crmzdy_87673590 nengli,crmzdy_87673587 xingge,crmzdy_87673581 zaojiao,crmzdy_87673593 quality,crmzdy_82058177 idjt,isnull(camp.crmzdy_85965390,'') channel,camp.crmzdy_82053775 idzx,camp.crmzdy_82053602 uniqueid,camp.crmzdy_82053439 m_code,camp.id,camp.crmzdy_82053647 gym,camp.crm_name phone,crmzdy_82053559 iskeep,crmzdy_82053558 remark,isnull(nullif(case when crmzdy_82053557='处理中' then '已首次联系' else crmzdy_82053557 end,''),'未处理') status,crmzdy_82053439 material_code,convert(varchar(20),isnull(dateadd(s,nullif(crmzdy_82053430,'')+8*3600,'1970-01-01 00:00:00'),create_time),120)dtenrol,crmzdy_82053429 centerid,@campaign campaign,crmzdy_82051555 sign_centerid,crmzdy_82051554 babyage,crmzdy_82051553 babyname,crmzdy_82051552 parentid,case when isnull(crmzdy_82051552,'')<>'' then '是' else '否' end isrecd,crmzdy_82051551 openid,convert(varchar(20),camp.create_time,120)create_time from crm_zdytable_238592_27045_238592_view camp where @campaignWhere @gymWhere @recentWhere @timelimitWhere"
		var url_fans = "https://camp.thelittlegym.com.cn/api/crm/get/subscribe";
        //var sql_pre_enrol_total="select pre.gym,num_pre,num_recnd,isnull(enrol.num,0) enrol_num,isnull(enrol.amount,0) amount from (select crmzdy_82051555 gym,count(1)num_pre,sum(case when isnull(camp.crmzdy_82051552,'')<>'' then 1 else 0 end) num_recnd from crm_zdytable_238592_27045_238592_view camp where @where_campaign and @where_dt and @where_gymcode group by crmzdy_82051555)pre left join (select gym,sum(num)num,sum(amount)amount from (select crmzdy_81757911 gym,count(distinct crmzdy_81620220_id) num,sum(crmzdy_81636090) amount from  crm_zdytable_238592_23796_238592_view ht where ht.crmzdy_81591866_id=351 and @where_ht_dt and @where_ht_gymcode and isnull(ht.crmzdy_81759941,'')='' group by crmzdy_81757911 union all select crmzdy_81803719,count(distinct bk.crmzdy_81759419_id) idzx,0 from crm_zdytable_238592_23696_238592_view bk join crm_zdytable_238592_23583_238592 bj on @where_bk_dt and bk.crmzdy_80631248_id=bj.id and bj.crmzdy_80612382_id=198 and @where_bj_gymcode and bk.crmzdy_81762908>0 left join crm_zdytable_238592_23796_238592_view ht on ht.id=bk.crmzdy_81636052_id and ht.crmzdy_81591866_id=351 where ht.crm_name is null group by bj.crmzdy_81803719 union all select bj.crmzdy_81803719 gym,count(distinct bmks.crmzdy_81747420_id),0 from crm_zdytable_238592_25118_238592_view bmks join crm_zdytable_238592_25117_238592_view bjap on @where_bmks_dt and bmks.crmzdy_81486479_id=bjap.id join crm_zdytable_238592_23583_238592 bj on @where_bj_gymcode and bjap.crmzdy_81486476_id=bj.id and bj.crmzdy_80612382_id=198 left join crm_zdytable_238592_23796_238592_view ht on ht.id=bjap.crmzdy_81598938_id and ht.crmzdy_81591866_id=351 where ht.crm_name is null group by bj.crmzdy_81803719)enrol group by gym)enrol on pre.gym=enrol.gym"
		var sql_pre_enrol_total="with jt as(select distinct * from(select jt.id,case when isnull(camp.crmzdy_82053430,'')='' then camp.create_time else dateadd(s,cast(camp.crmzdy_82053430 as int),'1970-01-01 08:00:00') end dtenrol,isnull(crmzdy_82058603,0) is_count,crmzdy_82051555 gym from crm_sj_238592 jt join crm_zdytable_238592_27045_238592_view camp on camp.crmzdy_82053258='2018小小奥运集训营' and camp.crm_name=jt.crmzdy_80620120 union all select jt.id,case when isnull(camp.crmzdy_82053430,'')='' then camp.create_time else dateadd(s,cast(camp.crmzdy_82053430 as int),'1970-01-01 08:00:00') end dtenrol,isnull(crmzdy_82058603,0) is_count,crmzdy_82051555 gym from crm_sj_238592 jt join crm_zdytable_238592_27045_238592_view camp on @where_campaign and camp.crmzdy_82053643=jt.crmzdy_80620120)jt),main as(select  coalesce(pre.gym,enrol.gym,kcht.gym)gym,num_pre,enrol.num enrol_num,enrol.amount enrol_amt,enrol.num2 enrol_num2,enrol.amount2 enrol_amt2,kcht.kcht_num,kcht.kcht_amt  from (select crmzdy_82051555 gym,count(1)num_pre from crm_zdytable_238592_27045_238592_view camp where @where_campaign and @where_dt and @where_gymcode group by crmzdy_82051555)pre full join (select gym,sum(num)num,sum(amount)amount,sum(num2)num2,sum(amount2)amount2 from (select crmzdy_81757911 gym,count(distinct crmzdy_81620220_id) num,sum(crmzdy_81636090) amount,count(distinct case when isnull(jt.id,0)=0 then crmzdy_81620220_id end) num2,sum(case when isnull(jt.id,0) =0 then crmzdy_81636090 end) amount2 from  crm_zdytable_238592_23796_238592_view ht join (select 1 x)x on ht.crmzdy_81591866_id=351 and @where_ht_dt and @where_ht_gymcode and isnull(ht.crmzdy_81759941,'')='' left join jt on jt.id=ht.crmzdy_80646020_id and jt.gym=ht.crmzdy_81757911 group by crmzdy_81757911 union all select crmzdy_81803719,count(distinct bk.crmzdy_81759419_id) idzx,0,count(distinct case when isnull(jt.id,0)=0 then bk.crmzdy_81759419_id end),0 from crm_zdytable_238592_23696_238592_view bk join crm_zdytable_238592_23583_238592 bj on @where_bk_dt and bk.crmzdy_80631248_id=bj.id and bj.crmzdy_80612382_id=198 and @where_bj_gymcode and bk.crmzdy_81762908>0 left join jt on bk.crmzdy_80631324_id=jt.id and jt.gym=bj.crmzdy_81803719 and is_count=1 left join crm_zdytable_238592_23796_238592_view ht on ht.id=bk.crmzdy_81636052_id and ht.crmzdy_81591866_id=351 where ht.crm_name is null group by bj.crmzdy_81803719 union all select bj.crmzdy_81803719 gym,count(distinct bmks.crmzdy_81747420_id),0,count(distinct case when isnull(jt.id,0)=0 then bmks.crmzdy_81747420_id end),0 from crm_zdytable_238592_25118_238592_view bmks join crm_zdytable_238592_25117_238592_view bjap on @where_bmks_dt and bmks.crmzdy_81486479_id=bjap.id join crm_zdytable_238592_23583_238592 bj on @where_bj_gymcode and bjap.crmzdy_81486476_id=bj.id and bj.crmzdy_80612382_id=198 left join jt on jt.id=bjap.crmzdy_81486474_id and jt.gym=bj.crmzdy_81803719 and is_count=1 left join crm_zdytable_238592_23796_238592_view ht on ht.id=bjap.crmzdy_81598938_id and ht.crmzdy_81591866_id=351 where ht.crm_name is null group by bj.crmzdy_81803719)enrol group by gym)enrol on pre.gym=enrol.gym full join (select crmzdy_81757911 gym,count(distinct crmzdy_81620220_id) kcht_num,sum(crmzdy_81636090) kcht_amt from  crm_zdytable_238592_23796_238592_view ht join (select 1 x)x on ht.crmzdy_81591866_id<>351 and @where_ht_dt and @where_ht_gymcode and isnull(ht.crmzdy_81759941,'')='' join jt on jt.id=ht.crmzdy_80646020_id and ht.crmzdy_80646021>jt.dtenrol group by crmzdy_81757911)kcht on pre.gym=kcht.gym),enrol3 as (SELECT crmzdy_82051555 gym,count(1)num FROM crm_zdytable_238592_27045_238592_view camp join (select 1 x)x on @where_campaign AND @where_gymcode and crmzdy_82053557='扣课报名夏令营' and isnull(crmzdy_82058603,0)=0  where not exists(select 1 from crm_zdytable_238592_23696_238592_view bk join crm_zdytable_238592_23583_238592 bj on bk.crmzdy_80631324_id=camp.crmzdy_82058177 and bk.crmzdy_80631248_id=bj.id and camp.crmzdy_82051555=bj.crmzdy_81803719 and bj.crmzdy_80612382_id=198 and bk.crmzdy_81762908>0) and not exists(select 1 from crm_zdytable_238592_25118_238592_view bmks join crm_zdytable_238592_25117_238592_view bjap on bjap.crmzdy_81486474_id=camp.crmzdy_82058177 and bmks.crmzdy_81486479_id=bjap.id join crm_zdytable_238592_23583_238592 bj on bjap.crmzdy_81486476_id=bj.id and camp.crmzdy_82051555=bj.crmzdy_81803719 and bj.crmzdy_80612382_id=198) and @where_update_dt group by crmzdy_82051555)select isnull(main.gym,enrol3.gym)gym,isnull(num_pre,0)num_pre,isnull(enrol_num,0)add;isnull(enrol3.num,0) enrol_num,enrol_amt,enrol_num2,enrol_amt2,kcht_num,kcht_amt from main full join enrol3 on enrol3.gym=main.gym;"
        var sql_pre_enrolByRecnd="with jt as(select distinct * from(select jt.id,case when isnull(camp.crmzdy_82051552,'')<>'' then '是' else '否' end is_recnd,isnull(crmzdy_82058603,0) is_count,crmzdy_82051555 gym from crm_sj_238592 jt join crm_zdytable_238592_27045_238592_view camp on @where_campaign and camp.crm_name=jt.crmzdy_80620120 union all select jt.id,case when isnull(camp.crmzdy_82051552,'')<>'' then '是'  else '否' end is_recnd,isnull(crmzdy_82058603,0) is_count,crmzdy_82051555 gym from crm_sj_238592 jt join crm_zdytable_238592_27045_238592_view camp on @where_campaign and camp.crmzdy_82053643=jt.crmzdy_80620120)jt),main as(select pre.type,num_pre,enrol.enrol_num,enrol.enrol_amt from (select case when isnull(camp.crmzdy_82051552,'')<>'' then '是' else '否' end type,count(1)num_pre from crm_zdytable_238592_27045_238592_view camp where @where_campaign and @where_dt and @where_gymcode group by case when isnull(camp.crmzdy_82051552,'')<>'' then '是' else '否' end)pre left join (select type,sum(enrol_num)enrol_num,sum(enrol_amt)enrol_amt from (select isnull(jt.is_recnd,'否') type,count(distinct crmzdy_81620220_id)enrol_num,sum(crmzdy_81636090) enrol_amt from crm_zdytable_238592_23796_238592_view ht left join jt on jt.id=ht.crmzdy_80646020_id  and jt.gym=ht.crmzdy_81757911 where ht.crmzdy_81591866_id=351 and @where_ht_dt and @where_ht_gymcode and isnull(ht.crmzdy_81759941,'')='' group by isnull(jt.is_recnd,'否') union all select isnull(jt.is_recnd,'否'),count(distinct bk.crmzdy_81759419_id) idzx,0 from crm_zdytable_238592_23696_238592_view bk join crm_zdytable_238592_23583_238592 bj on @where_bk_dt and bk.crmzdy_80631248_id=bj.id and bj.crmzdy_80612382_id=198 and bj.crmzdy_81803719 between '500005' and '600005' and bk.crmzdy_81762908>0 left join jt on jt.id=bk.crmzdy_80631324_id and jt.gym=bj.crmzdy_81803719 and is_count=1 and jt.gym=bj.crmzdy_81803719 and is_count=1 left join crm_zdytable_238592_23796_238592_view ht on ht.id=bk.crmzdy_81636052_id and ht.crmzdy_81591866_id=351 where ht.crm_name is null group by isnull(jt.is_recnd,'否') union all select isnull(jt.is_recnd,'否'),count(distinct bmks.crmzdy_81747420_id),0 from crm_zdytable_238592_25118_238592_view bmks join crm_zdytable_238592_25117_238592_view bjap on @where_bmks_dt and bmks.crmzdy_81486479_id=bjap.id join crm_zdytable_238592_23583_238592 bj on bj.crmzdy_81803719 between '500005' and '600005' and bjap.crmzdy_81486476_id=bj.id and bj.crmzdy_80612382_id=198 left join jt on jt.id=bjap.crmzdy_81486474_id and jt.gym=bj.crmzdy_81803719 and is_count=1 left join crm_zdytable_238592_23796_238592_view ht on ht.id=bjap.crmzdy_81598938_id and ht.crmzdy_81591866_id=351 where ht.crm_name is null group by isnull(jt.is_recnd,'否'))enrol group by type)enrol on pre.type=enrol.type),enrol3 as (select type,sum(num)num from(select crmzdy_82051555 gym,case when isnull(camp.crmzdy_82051552,'')<>'' then '是' else '否' end type,count(1)num from crm_zdytable_238592_27045_238592_view camp join (select 1 x)x on @where_campaign and @where_gymcode and crmzdy_82053557='扣课报名夏令营' and isnull(crmzdy_82058603,0)=0  where not exists(select 1 from crm_zdytable_238592_23696_238592_view bk join crm_zdytable_238592_23583_238592 bj on bk.crmzdy_80631324_id=camp.crmzdy_82058177 and  bk.crmzdy_80631248_id=bj.id and camp.crmzdy_82051555=bj.crmzdy_81803719 and bj.crmzdy_80612382_id=198  and bk.crmzdy_81762908>0) and not exists(select 1 from crm_zdytable_238592_25118_238592_view bmks join crm_zdytable_238592_25117_238592_view bjap on bjap.crmzdy_81486474_id=camp.crmzdy_82058177 and bmks.crmzdy_81486479_id=bjap.id join crm_zdytable_238592_23583_238592 bj on  bjap.crmzdy_81486476_id=bj.id and camp.crmzdy_82051555=bj.crmzdy_81803719 and bj.crmzdy_80612382_id=198) and @where_update_dt group by crmzdy_82051555,case when isnull(camp.crmzdy_82051552,'')<>'' then '是' else '否' end)a group by type)select isnull(enrol3.type,main.type)type,isnull(num_pre,0)num_pre,isnull(enrol_num,0)add;isnull(enrol3.num,0)enrol_num,isnull(enrol_amt,0)enrol_amt from enrol3 full join main on enrol3.type=main.type";
		var sql_kxj_ht ="with kxj as(select  camp.crmzdy_82053602 uniqueid,camp.id,camp.crmzdy_82053647 gym,camp.crm_name phone,crmzdy_82053643 phone2,isnull(nullif(case when crmzdy_82053557='处理中' then '已首次联系' else crmzdy_82053557 end,''),'未处理') status,DATEADD(S,crmzdy_82053430 add; 8 * 3600,'1970-01-01 00:00:00') dtenrol,crmzdy_82053429 centerid,crmzdy_82053258 campaign,crmzdy_82051555 sign_centerid,crmzdy_82051554 babyage,crmzdy_82051553 babyname,crmzdy_82051551 openid,camp.create_time from crm_zdytable_238592_27045_238592_view camp where crmzdy_82053258='开学季'),zx as(select distinct idzx,gym,phone,dtenrol from(select zx.id idzx,zx.crmzdy_81620171 gym,jt.crmzdy_80620120 phone,dtenrol from kxj join crm_sj_238592_view jt on jt.crmzdy_80620120=kxj.phone join crm_zdytable_238592_25111_238592_view zx on zx.crmzdy_81611091_id=jt.id and kxj.sign_centerid=zx.crmzdy_81769392 union all select zx.id idzx,zx.crmzdy_81620171 gym,jt.crmzdy_80620120 phone,dtenrol from kxj join crm_sj_238592_view jt on jt.crmzdy_80620120=kxj.phone2 join crm_zdytable_238592_25111_238592_view zx on zx.crmzdy_81611091_id=jt.id and kxj.sign_centerid=zx.crmzdy_81769392)a),ht as(select jine,idzx,gym,phone,dtenrol,dtbm,convert(varchar(10),wkfirst,120)add;' - 'add;convert(varchar(10),wklast,120)span,type from(select idzx,gym,crmzdy_81636090 jine,phone,dtenrol,ht.crmzdy_80646021 dtbm,dateadd(day,1-(datepart(weekday,ht.crmzdy_80646021)add;@@datefirst-1)%7,ht.crmzdy_80646021)wkfirst,dateadd(day,7-(datepart(weekday,ht.crmzdy_80646021)add;@@datefirst-1)%7,ht.crmzdy_80646021)wklast,isnull((select top 1 '续报' from crm_zdytable_238592_23796_238592_view lsht where lsht.crmzdy_81620220_id=ht.crmzdy_81620220_id and lsht.crmzdy_81622226<>'全额退课' and isnull(lsht.crmzdy_81762904,'课程')='课程' and lsht.id<>ht.id and ht.crmzdy_80646021>lsht.crmzdy_80646021),'新报')type from zx join crm_zdytable_238592_23796_238592_view ht on ht.crmzdy_81620220_id=zx.idzx and ht.crmzdy_81622226<>'全额退课' and ht.crmzdy_81591866_id<>306 and @where_ht_dt and ht.crmzdy_80646021>dtenrol)a)"; 
        sql_kxj_ht +="select isnull(span,'所有')time,case when grouping(span)=1 then '总 计' when grouping(gym)=1 then ' 合计' else gym end gym,count(1)num,sum(jine)jin,count(case when type='新报' then 1 end)num_x,sum(case when type='新报' then jine else 0 end)jin_x  from ht group by span,gym with rollup order by time desc,num desc";
        var member_stat="select *,期末截止会员总数+期末截止非会员总数 期末截止用户总数 from(select (select count(distinct zx.crmzdy_81611091_id)num from crm_zdytable_238592_25111_238592 zx join (select 1 x)x on zx.isdelete=0 and @whereend and zx.crmzdy_81769392 like '50%' cross apply(select top 1 ht.create_time from crm_zdytable_238592_23796_238592_view ht where ht.crmzdy_81620220_id =zx.id and ht.crmzdy_81622226<>'全额退课' order by ht.id)ht where @whereht)会员,(select count(distinct zx.crmzdy_81611091_id) num from crm_zdytable_238592_25111_238592 zx join (select 1 x )x on zx.isdelete=0 and @wherezx and zx.crmzdy_81769392 like '50%' left join crm_zdytable_238592_23796_238592_view ht on ht.crmzdy_81620220_id =zx.id and ht.crmzdy_81762904='课程' and ht.crmzdy_81622226<>'全额退课' where ht.id is null)非会员,(select count(distinct zx.id) from crm_zdytable_238592_25111_238592_view zx,crm_zdytable_238592_23796_238592_view ht where ht.crmzdy_81620220_id=zx.id and ht.crmzdy_81622226<>'全额退课' and ht.crmzdy_81762904='课程' and datediff(d,'@dtend',/*到期日期*/ ht.crmzdy_81733324)>=0 and /*bmrq*/ ht.crmzdy_80646021<='@dtend' and exists(select 1 from crm_zdytable_238592_25115_238592_view bmksb where ht.id=bmksb.crmzdy_81486464_id and bmksb.crmzdy_81939586>0)) 期末截止活跃会员总数,(select count(distinct zx.crmzdy_81611091_id)num from crm_zdytable_238592_25111_238592 zx join (select 1 x)x on zx.isdelete=0 and @whereend  and zx.crmzdy_81769392 like '50%' cross apply(select top 1 ht.create_time from crm_zdytable_238592_23796_238592_view ht where ht.crmzdy_81620220_id =zx.id and ht.crmzdy_81622226<>'全额退课' order by ht.id)ht)期末截止会员总数,(select count(distinct zx.crmzdy_81611091_id) num from crm_zdytable_238592_25111_238592 zx join (select 1 x )x on zx.isdelete=0 and zx.create_time<='@dtend' and zx.crmzdy_81769392 like '50%' left join crm_zdytable_238592_23796_238592_view ht on ht.crmzdy_81620220_id =zx.id and ht.crmzdy_81762904='课程' and ht.crmzdy_81622226<>'全额退课' where ht.id is null)期末截止非会员总数)a"
		var sql_coupon="with tmp as(select coupon.phone id,(select top 1 * from (select jt.crmzdy_80620120 phone,jt.id jtid,jt.crmzdy_80652377 relation,jt.crm_surname username,zx.flag from crm_sj_238592_view jt join (select '1'x)x on jt.crmzdy_80620120=coupon.phone cross apply(select top 1 id,case when isnull(crmzdy_81802303,'')='' then 1 else 2 end flag from crm_zdytable_238592_25111_238592_view zx where jt.id=zx.crmzdy_81611091_id)zx union all select top 1 * from(select jt.crmzdy_80620120 phone,jt.id,jt.crmzdy_80652377 relation,jt.crm_surname,zx.flag from crm_sj_238592_view jt join (select '1' x)x on jt.crm_tel=coupon.phone cross apply(select top 1 id,case when isnull(crmzdy_81802303,'')='' then 1 else 2 end flag from crm_zdytable_238592_25111_238592_view zx where jt.id=zx.crmzdy_81611091_id)zx union all select jt.crmzdy_80620120 phone,jt.id,con.crmzdy_80610682 relation,con.crm_surname,zx.flag from crm_sj_238592_view jt join crm_lxr_238592_view con on con.crm_mobile =coupon.phone and jt.id=con.crmzdy_80610683_id cross apply(select top 1 id,case when isnull(crmzdy_81802303,'')='' then 1 else 2 end flag from crm_zdytable_238592_25111_238592_view zx where jt.id=zx.crmzdy_81611091_id)zx)jt order by jt.id desc)jt for json auto,without_array_wrapper) jt,coupon.* from (@sql_data)coupon)select /*main*/id,JSON_VALUE(jt, '$.jtid') idjt,case JSON_VALUE(jt, '$.flag') when 1 then '非会员' when 2 then '会员' else '新人' end type,tmp.centerid,tmp.user_name,tmp.coupon_name,tmp.end_date,case tmp.status when 1 then '券有效' when 2 then '已核销' when 3 then '已过期' end status,phone from tmp";
        var sql_handle_down="select gym.crm_name 中心,stat.人数 from(select crmzdy_82051555 gymcode,count(distinct crm_name)人数 from crm_zdytable_238592_27045_238592_view camp where create_time between  '@dtstart' and '@dtend' and crmzdy_82051555 between '500005' and '600005' and @where_campaign and ((isnull(nullif(case when crmzdy_82053557='处理中' then '已首次联系' else crmzdy_82053557 end,''),'未处理') ='未处理' and datediff(mi,camp.create_time,getdate())>240) or (isnull(nullif(crmzdy_82053557,''),'未处理') <>'未处理' and crmzdy_87682393 is not null and datediff(mi,camp.create_time,crmzdy_87682393)>240))  group by crmzdy_82051555)stat join crm_zdytable_238592_23594_238592_view gym on gym.crmzdy_80620116 =stat.gymcode order by 人数 desc"
        var sql_handle="select gym.crm_name 中心,stat.人数 from(select crmzdy_82051555 gymcode,count(distinct crm_name)人数 from crm_zdytable_238592_27045_238592_view camp where create_time between '@dtstart' and '@dtend' and crmzdy_82051555 between '500005' and '600005' and @where_campaign and (isnull(nullif(case when crmzdy_82053557='处理中' then '已首次联系' else crmzdy_82053557 end,''),'未处理') <>'未处理' and datediff(mi,camp.create_time,isnull(crmzdy_87682393,'2114-01-01'))<=240)  group by crmzdy_82051555)stat join crm_zdytable_238592_23594_238592_view gym on gym.crmzdy_80620116 =stat.gymcode order by 人数  desc"
        var sql_handle_time_ave=" select gym.crm_name gym,stat.time,mx_time,stat.num from(select crmzdy_82051555 gymcode,avg(datediff(mi,camp.create_time,isnull(crmzdy_87682393,getdate())))time,max(datediff(mi,camp.create_time,isnull(crmzdy_87682393,getdate())))mx_time,count(distinct crm_name)num from crm_zdytable_238592_27045_238592_view camp where create_time between '@dtstart' and '@dtend' and crmzdy_82051555 between '500005' and '600005' and @where_campaign and not(crmzdy_87682393 is null and isnull(nullif(crmzdy_82053557,''),'未处理') <>'未处理') group by crmzdy_82051555)stat join crm_zdytable_238592_23594_238592_view gym on gym.crmzdy_80620116=stat.gymcode";
        var sql_campaign_trans_stat="with p1 as (select campaign,count(distinct idjt)num_lz,count(distinct case when status<>'未处理' then idjt end )已经在跟进 from (select crmzdy_82058177 idjt,camp.crmzdy_82053647 gym,camp.crm_name phone,isnull(nullif(case when crmzdy_82053557='处理中' then '已首次联系' else crmzdy_82053557 end,''),'未处理') status,crmzdy_82053439 material_code,convert(varchar(20),isnull(dateadd(s,nullif(crmzdy_82053430,'')+8*3600,'1970-01-01 00:00:00'),create_time),120)dtenrol,crmzdy_82053429 centerid,crmzdy_82053258 campaign from crm_zdytable_238592_27045_238592_view camp where @where_gymcode and @where_dt and @where_campaign and crmzdy_82053258 not like '测试%' and crmzdy_82053258 not like '%test%' and isnull(crmzdy_82053258,'')<>'')a group by campaign),ht as(select campaign,count(1)num_ht,sum(cast(amt as float))amt from (select crmzdy_82053258 campaign,isnull(crmzdy_87677136,'') amt,crmzdy_87677139 from crm_zdytable_238592_27045_238592_view camp where @where_gymcode and @where_dtht and @where_campaign and isnull(crmzdy_87677136,'')<>'' and crmzdy_82053258 not like '测试%' and crmzdy_82053258 not like '%test%' and isnull(crmzdy_82053258,'')<>'')a group by campaign),ty as (select crmzdy_82053258 campaign,count(1)num_ty from crm_zdytable_238592_27045_238592_view camp cross apply(select top 1 crmzdy_80650731 dtty from crm_zdytable_238592_23576_238592_view ty where ty.crmzdy_80610716_id=camp.crmzdy_82058177 and crmzdy_80650306='出勤' order by dtty)ty where @where_gymcode and @where_dtty and @where_campaign and crmzdy_82053258 not like '测试%' and crmzdy_82053258 not like '%test%' and isnull(crmzdy_82053258,'')<>'' group by crmzdy_82053258)"; 
        sql_campaign_trans_stat+="select coalesce(p1.campaign,ht.campaign,ty.campaign)campaign,isnull(num_lz,0) 产生例子数,isnull(已经在跟进,0)已经在跟进,isnull(num_ty,0) 出席体验,isnull(num_ht,0) 签约数量,cast(isnull(amt,0) as decimal(12,2))签约金额 from p1 full join ht on p1.campaign=ht.campaign full join ty on ty.campaign=p1.campaign";
	</script>

    <style>
        .ui .label.total{
            font-size: 2.4em;
        }
	    #result{
		  width:98%!important;
		}
        .ui .checkbox {
            cursor:pointer!important;
            margin-right: 20px!important;
        }
        select {
          border: none;
          outline: none;
          cursor: default;
        }
        .fans{
            font-size: 1.8em;
        }
		th{
		  font-size:1.6em;
		}
		td{
		  font-size:1.4em;
		}
		.bold{
		  font-size:1.8em;
		  font-weight:900;
		}
		.blue{
		  color:blue;
		  font-size:1.4em;
		  font-weight:500;
		}
    </style>
</head>

<body>
    <!--[if lt IE 11]>
     <div class="browser-happy">
         <div class="content">
             <li>浏览器太旧了，为了兼容与美观请更新您的浏览器</p>
             <a href="http://browsehappy.com/">立即更新</a>
         </div>
     </div>
    <![endif]-->
	<div id="app"></div> 
    <script src="https://bbk.800app.com/uploadfile/staticresource/238592/279833/vue.js"></script>
    <script src="https://bbk.800app.com/uploadfile/staticresource/238592/279833/vue-resource.js"></script>
    <script src="https://bbk.800app.com/uploadfile/staticresource/238592/279833/polyfill.min.js"></script>
    <script src="https://bbk.800app.com/uploadfile/staticresource/238592/279833/axios.min.js"></script>
    <script src="https://bbk.800app.com/uploadfile/staticresource/238592/279833/browser.min.js"></script>
	<script src="build/campaign_page.js"></script>
</body>
</html>