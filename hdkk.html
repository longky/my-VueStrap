<!DOCTYPE html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>每日电话报表</title>
    <link rel="shortcut icon" href="https://static.thelittlegym.com.cn/assert/img/logo.ico"> 
    <link rel="stylesheet" href="https://static.thelittlegym.com.cn/assert/ui/semantic/semantic.min.css">
    <link rel="stylesheet" href="https://static.thelittlegym.com.cn/assert/ui/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="https://bbk.800app.com/uploadfile/staticresource/238592/279833/tlgc.css">
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link rel="stylesheet" href="https://static.thelittlegym.com.cn/assert/ui/iview/styles/iview.css">
    <!--[if lt IE 9]>
      <link rel="stylesheet" href="incompatible.css">
    <![endif]-->
    <script src="https://bbk.800app.com/uploadfile/staticresource/238592/279833/jquery-1.11.3.min.js"></script>
    <script src="https://bbk.800app.com/uploadfile/staticresource/238592/279833/gym.js"></script>
    <script src="https://bbk.800app.com/uploadfile/staticresource/238592/279833/vue.js"></script>
    <script src="https://bbk.800app.com/uploadfile/staticresource/238592/279833/polyfill.min.js"></script>
    <script src="https://bbk.800app.com/uploadfile/staticresource/238592/279833/axios.min.js"></script>
    <script src="https://bbk.800app.com/uploadfile/staticresource/238592/279833/vue-resource.js"></script>
    <script src="https://bbk.800app.com/uploadfile/staticresource/238592/279833/browser.min.js"></script>
  

    <script>
        var url_jsonp = "https://bbk.800app.com/uploadfile/staticresource/238592/279833/dataInterface_jsonp_uni.aspx";
        var url_local = "https://bbk.800app.com//uploadfile/staticresource/238592/279833/api_auto_json.aspx";
        var sql_getGym = "select crm_name name,gym.crmzdy_80620116 code,id from crm_zdytable_238592_23594_238592_view gym join (select top 1 crm_jiandang,crmzdy_81611236 gymlist from crm_yh_238592_view where id=iduser)yh on gym.crmzdy_80620116 >'500004' and gym.crmzdy_82037329=1 and (yh.crm_jiandang in ('@consultant','@administrator','市场顾问','市场专员') or (yh.crm_jiandang in ('中心运营总监','中心运营总监(练习)','中心员工','课程主管','销售主管','中心员工(练习)') and charindex(gym.crm_name,yh.gymlist)>0)) order by name";
        var sql_quanxian ="select id,crm_jiandang from crm_yh_238592_view where id=iduser";
        //var sql_getPhonePlans="select crmzdy_81611091_id,id,crmzdy_81620163 dtZx,crmzdy_81754947 isShow,crmzdy_81754948 dtShow,crmzdy_81636187 access into #zx from crm_zdytable_238592_25111_238592 zx where crmzdy_81620171_id=@idgym and isdelete=0; create index ix_dtzx on #zx(dtZx);create index ix_id on #zx(id);select 手机,孩子+' '+年龄 孩子,体验日期,isnull(班级,'') 班级,考勤状态,年龄,type,idZx into #tmp from(/*type 1*/ select 1 type,hz.crmzdy_81802109 手机,hz.crm_name 孩子,hz.crmzdy_80653845 生日,hz.crmzdy_81497217 年龄,#zx.id idZx,'' 体验日期,''班级,''考勤状态 from #zx left join crm_zdytable_238592_23893_238592_view hz on #zx.crmzdy_81611091_id=hz.crmzdy_80653840_id where #zx.dtZx = dateadd(d,-3,'@dtReport') and not exists(select 1 from crm_zdytable_238592_23576_238592_view ty where #zx.id=ty.crmzdy_81620307_id and hz.id=ty.crmzdy_80653847_id ) and /*未报名*/ not exists(select 1 from crm_zdytable_238592_23796_238592_view ht where crmzdy_81620220_id=#zx.id and crmzdy_81622226<>'全额退课') union all /*type 2-4*/ select case when datediff(d,体验日期,'@dtReport')=2 and 考勤状态 ='出勤' and not exists(select 1 from crm_zdytable_238592_23796_238592 ht where isdelete=0 and ht.crmzdy_81620220_id=#zx.id and 体验日期<=ht.crmzdy_80646021) then 2 when datediff(d,体验日期,'@dtReport')=1 and 考勤状态<>'出勤' then 3 when datediff(d,体验日期,'@dtReport')=-1 then 4 else 0 end type,hz.crmzdy_81802109 手机,hz.crm_name 孩子,hz.crmzdy_80653845 生日,hz.crmzdy_81497217 年龄,#zx.id idZx,convert(varchar(10),ty.体验日期,120)体验日期,班级,考勤状态 from #zx left join crm_zdytable_238592_23893_238592_view hz on #zx.crmzdy_81611091_id=hz.crmzdy_80653840_id cross apply (select top 1 ty.crmzdy_80650731 体验日期,ty.crmzdy_80631243 班级,ty.crmzdy_80650306 考勤状态 from crm_zdytable_238592_23576_238592_view ty where #zx.dtZx<'@dtReport' and #zx.id=ty.crmzdy_81620307_id and hz.id=ty.crmzdy_80653847_id and ty.crmzdy_80650731<=dateadd(d,1,'@dtReport') and ty.crmzdy_80650731>=dateadd(d,-2,'@dtReport') order by ty.create_time desc,crmzdy_80650731 desc)ty union all/*type 5-6*/ select 5 type,hz.crmzdy_81802109 手机, hz.crm_name 孩子,hz.crmzdy_80653845 生日,hz.crmzdy_81497217 年龄,#zx.id idZx,convert(varchar(10),ty.体验日期,120)体验日期,班级,考勤状态 from #zx join (select ''x)x on #zx.isShow='是' and #zx.dtShow='@dtReport' left join crm_zdytable_238592_23893_238592_view hz on #zx.crmzdy_81611091_id=hz.crmzdy_80653840_id outer apply (select top 1 ty.crmzdy_80650731 体验日期,ty.crmzdy_80631243 班级,ty.crmzdy_80650306 考勤状态 from crm_zdytable_238592_23576_238592_view ty where #zx.id=ty.crmzdy_81620307_id and hz.id=ty.crmzdy_80653847_id and #zx.dtZx<='@dtReport' order by ty.create_time desc,crmzdy_80650731 desc)ty union all select top 100 6 type,hz.crmzdy_81802109 手机,hz.crm_name 孩子,hz.crmzdy_80653845 生日,hz.crmzdy_81497217 年龄,#zx.id idZx,convert(varchar(10),ty.体验日期,120)体验日期,班级,考勤状态 from #zx join (select ''x)x on day('@dtReport')=1 left join crm_zdytable_238592_23893_238592_view hz on #zx.crmzdy_81611091_id=hz.crmzdy_80653840_id outer apply (select top 1 ty.crmzdy_80650731 体验日期,ty.crmzdy_80631243 班级,ty.crmzdy_80650306 考勤状态 from crm_zdytable_238592_23576_238592_view ty where #zx.id=ty.crmzdy_81620307_id and hz.id=ty.crmzdy_80653847_id order by crmzdy_80650731 desc,ty.create_time desc)ty where #zx.isShow='否' and #zx.access!='缘分暂时没到！' and #zx.dtZx<'@dtReport' and not exists(select 1 from crm_zdytable_238592_25121_238592_view gt where gt.create_time<dateadd(d,1,getdate()) and gt.create_time >=dateadd(d,-30,getdate()) and crmzdy_81748926_id=#zx.id) and not exists(select 1 from crm_zdytable_238592_23576_238592_view ty where #zx.id=ty.crmzdy_81620307_id and hz.id=ty.crmzdy_80653847_id and datediff(d,ty.crmzdy_80650731,'@dtReport')<0) and not exists(select 1 from crm_zdytable_238592_23796_238592_view ht where crmzdy_81620220_id=#zx.id and crmzdy_81622226<>'全额退课') order by #zx.dtZx desc)a where type>0;select zx.id,zx.crmzdy_81611091_id idjt,zx.crmzdy_81611091 家长,zx.crmzdy_81756916 手机,isnull(孩子,'')孩子,zx.crmzdy_87682347 今日电话老师,zx.crmzdy_87682347_id idls,zx.crmzdy_81636452 负责老师,体验日期,班级,考勤状态,zx.crmzdy_81754949 每日电话说明,replace(replace('<b>'+ltrim(isnull( '家长需求：'+nullif(crmzdy_87677161,''),'')+isnull( ' 孩子性格：'+nullif(crmzdy_87676839,''),'')+isnull( ' 距离：'+nullif(crmzdy_87676845,''),'')+isnull( ' 早教课程：'+nullif(crmzdy_87676842,''),'')+isnull( ' 家庭带养人：'+nullif(crmzdy_87676848 ,''),'')),' ','，')+'</b> '+replace(case when PATINDEX('|%|%|%|%',isnull(crmzdy_81802275,''))>0 then substring(isnull(crmzdy_81802275,''),2,charindex('|',isnull(crmzdy_81802275,''),2)-3)+substring(replace(reverse(LEFT(reverse(isnull(crmzdy_81802275,'')),CHARINDEX('|',reverse(isnull(crmzdy_81802275,'')),charindex('|',reverse(isnull(crmzdy_81802275,'')))+1))),'|',''),0,8000) else substring(replace(isnull(crmzdy_81802275,''),'|',''),0,8000) end,CHAR(13),' '),CHAR(10),'。') 沟通记录,年龄,convert(varchar(10),zx.crmzdy_81620163,120) 咨询日期,type,zx.crmzdy_82025400 最近体验信息,(select top 1 convert(varchar(10),create_time,120) from crm_zdytable_238592_23576_238592 ty where ty.isdelete=0 and ty.crmzdy_81620307_id=zx.id order by create_time desc)dtappoint from (select row_number() over(partition by idzx,孩子 order by type)xh,* from #tmp)a,crm_zdytable_238592_25111_238592_view zx where xh=1 and a.idZx=zx.id order by type, 咨询日期 desc, 班级, 家长, 孩子";
        var sql_getPhonePlans="select crmzdy_81611091_id,id,crmzdy_81620163 dtzx,crmzdy_81754947 isshow,crmzdy_81754948 dtshow,crmzdy_81636187 access into #zx from crm_zdytable_238592_25111_238592 zx where crmzdy_81620171_id=@idgym and isdelete=0; create index ix_dtzx on #zx(dtzx);create index ix_id on #zx(id);select 手机,孩子+' '+年龄 孩子,体验日期,isnull(班级,'') 班级,考勤状态,年龄,type,idzx into #tmp from(/*type 1*/ select 1 type,hz.crmzdy_81802109 手机,hz.crm_name 孩子,hz.crmzdy_80653845 生日,hz.crmzdy_81497217 年龄,#zx.id idzx,'' 体验日期,''班级,''考勤状态 from #zx join (select 1 x)x on #zx.dtzx = dateadd(d,-3,'@dtReport') left join crm_zdytable_238592_23893_238592_view hz on #zx.crmzdy_81611091_id=hz.crmzdy_80653840_id left join crm_zdytable_238592_23576_238592 ty on #zx.id=ty.crmzdy_81620307_id and hz.id=ty.crmzdy_80653847_id and ty.isdelete=0 /*未报名*/left join crm_zdytable_238592_23796_238592_view ht on crmzdy_81620220_id=#zx.id and crmzdy_81622226<>'全额退课' where ty.id is null and ht.id is null union all /*type 2-4*/ select case when datediff(d,体验日期,'@dtReport')=2 and 考勤状态 ='出勤' and not exists(select 1 from crm_zdytable_238592_23796_238592 ht where isdelete=0 and ht.crmzdy_81620220_id=#zx.id and 体验日期<=ht.crmzdy_80646021) then 2 when datediff(d,体验日期,'@dtReport')=1 and 考勤状态<>'出勤' then 3 when datediff(d,体验日期,'@dtReport')=-1 then 4 else 0 end type,hz.crmzdy_81802109 手机,hz.crm_name 孩子,hz.crmzdy_80653845 生日,hz.crmzdy_81497217 年龄,#zx.id idzx,convert(varchar(10),ty.体验日期,120)体验日期,班级,考勤状态 from #zx left join crm_zdytable_238592_23893_238592_view hz on #zx.crmzdy_81611091_id=hz.crmzdy_80653840_id cross apply (select top 1 ty.crmzdy_80650731 体验日期,ty.crmzdy_80631243 班级,ty.crmzdy_80650306 考勤状态 from crm_zdytable_238592_23576_238592_view ty where #zx.dtzx<'@dtReport' and #zx.id=ty.crmzdy_81620307_id and hz.id=ty.crmzdy_80653847_id and ty.crmzdy_80650731<=dateadd(d,1,'@dtReport') and ty.crmzdy_80650731>=dateadd(d,-2,'@dtReport') order by ty.create_time desc,crmzdy_80650731 desc)ty union all/*type 5-6*/ select 5 type,hz.crmzdy_81802109 手机, hz.crm_name 孩子,hz.crmzdy_80653845 生日,hz.crmzdy_81497217 年龄,#zx.id idzx,convert(varchar(10),ty.体验日期,120)体验日期,班级,考勤状态 from #zx join (select ''x)x on #zx.isshow='是' and #zx.dtshow='@dtReport' left join crm_zdytable_238592_23893_238592_view hz on #zx.crmzdy_81611091_id=hz.crmzdy_80653840_id outer apply (select top 1 ty.crmzdy_80650731 体验日期,ty.crmzdy_80631243 班级,ty.crmzdy_80650306 考勤状态 from crm_zdytable_238592_23576_238592_view ty where #zx.id=ty.crmzdy_81620307_id and hz.id=ty.crmzdy_80653847_id and #zx.dtzx<='@dtReport' order by ty.create_time desc,crmzdy_80650731 desc)ty union all select top 100 6 type,hz.crmzdy_81802109 手机,hz.crm_name 孩子,hz.crmzdy_80653845 生日,hz.crmzdy_81497217 年龄,#zx.id idzx,convert(varchar(10),ty.体验日期,120)体验日期,班级,考勤状态 from #zx join (select ''x)x on day('@dtReport')=1 and  #zx.isshow='否' and #zx.access!='缘分暂时没到！' and #zx.dtzx<'@dtReport' left join crm_zdytable_238592_23893_238592_view hz on #zx.crmzdy_81611091_id=hz.crmzdy_80653840_id outer apply (select top 1 ty.crmzdy_80650731 体验日期,ty.crmzdy_80631243 班级,ty.crmzdy_80650306 考勤状态 from crm_zdytable_238592_23576_238592_view ty where #zx.id=ty.crmzdy_81620307_id and hz.id=ty.crmzdy_80653847_id order by crmzdy_80650731 desc,ty.create_time desc)ty left join crm_zdytable_238592_25121_238592_view gt on gt.create_time<dateadd(d,1,getdate()) and gt.create_time >=dateadd(d,-30,getdate()) and gt.crmzdy_81748926_id=#zx.id left join crm_zdytable_238592_23576_238592_view ty0 on #zx.id=ty0.crmzdy_81620307_id and hz.id=ty0.crmzdy_80653847_id and datediff(d,ty0.crmzdy_80650731,'@dtReport')<0  left join crm_zdytable_238592_23796_238592_view ht on crmzdy_81620220_id=#zx.id and crmzdy_81622226<>'全额退课' where gt.id is null and ht.id is null and ty0.id is null order by #zx.dtzx desc)a where type>0;";
        sql_getPhonePlans+="select JSON_MODIFY(res,'$.phones',phones) from(select isnull((select zx.id,zx.crmzdy_81611091_id idjt,zx.crmzdy_81611091 家长,zx.crmzdy_81756916 手机,isnull(孩子,'')孩子,isnull(zx.crmzdy_87682347,'') 今日电话老师,zx.crmzdy_87682347_id idls,zx.crmzdy_81636452_id idfzls,zx.crmzdy_81636452 负责老师,体验日期,班级,考勤状态,replace(replace(replace(zx.crmzdy_81754949,char(13),' '),char(10),'。'),char(9),' ')每日电话说明,replace(replace(replace('<b>'+ltrim(isnull( '家长需求：'+nullif(crmzdy_87677161,''),'')+isnull( ' 孩子性格：'+nullif(crmzdy_87676839,''),'')+isnull( ' 距离：'+nullif(crmzdy_87676845,''),'')+isnull( ' 早教课程：'+nullif(crmzdy_87676842,''),'')+isnull( ' 家庭带养人：'+nullif(crmzdy_87676848 ,''),'')),' ','，')+'</b> '+replace(case when patindex('|%|%|%|%',isnull(crmzdy_81802275,''))>0 then substring(isnull(crmzdy_81802275,''),2,charindex('|',isnull(crmzdy_81802275,''),2)-3)+substring(replace(reverse(left(reverse(isnull(crmzdy_81802275,'')),charindex('|',reverse(isnull(crmzdy_81802275,'')),charindex('|',reverse(isnull(crmzdy_81802275,'')))+1))),'|',''),0,8000) else substring(replace(isnull(crmzdy_81802275,''),'|',''),0,8000) end,char(13),' '),char(10),'。'),char(9),' ') 沟通记录,年龄,convert(varchar(10),zx.crmzdy_81620163,120) 咨询日期,type,zx.crmzdy_82025400 最近体验信息,(select convert(varchar(10),create_time,120)+';' from crm_zdytable_238592_23576_238592 ty where ty.isdelete=0 and ty.crmzdy_81620307_id=zx.id for xml path(''))dtappoint from (select row_number() over(partition by idzx,孩子 order by type)xh,* from #tmp)a,crm_zdytable_238592_25111_238592_view zx where xh=1 and a.idzx=zx.id order by type,咨询日期 desc,班级,家长,孩子 for json path),'[]')phones,(select 0 errcode,'ok' errmsg,'[]'phones,'@sql' sql for json path,without_array_wrapper)res)a";    
        var sql_getBirthdayList="select 7 type,zx.id id,isnull(crmzdy_87682347,'') 今日电话老师,zx.crmzdy_87682347_id idls,zx.crmzdy_81636452_id idfzls,zx.crmzdy_81636452 负责老师,crmzdy_81802546_id idjt,crmzdy_81802546 家长, (crmzdy_81802541 +' '+crmzdy_81497217) 孩子,crmzdy_81802109 手机,convert(varchar(10),crmzdy_81802547,120) 生日 from crm_zdytable_238592_26317_238592_view srh join crm_zdytable_238592_23893_238592_view hz on hz.id=srh.crmzdy_81802541_id and srh.crmzdy_81803171_id=@idgym and srh.crmzdy_81802547 between dateadd(d,-7,'@dtReport')  and '@dtReport' join crm_zdytable_238592_25111_238592_view zx on zx.id=srh.crmzdy_81767983_id;"
        var sql_ls="select top 1 0 errcode,'ok'errmsg,(select yh.id,yh.crm_qm name from crm_zdytable_238592_23594_238592_view gym,crm_yh_238592_view yh where gym.id=@idGym and charindex(gym.crm_name,yh.crmzdy_81611236)>0 and yh.crm_yiqiyong=1 and yh.crm_qm<>'测试员工' order by name for json auto)newers,'@sql'sql from crm_yh_238592_view yh for json auto,without_array_wrapper"
    </script>

</head>


<body>
     <!--[if lt IE 11]>
     <div class="browser-happy">
         <div class="content">
             <li>浏览器太旧了，为了兼容与美观请更新您的浏览器</p>
             <a href="http://browsehappy.com/">立即更新</a>
         </div>
     </div>
    <![endif]-->
	<div id="app">
      <Daily-phone></Daily-phone>
    </div> 
    <script src="/build/dailyPhone_page.js"></script>
</body>
</html>
